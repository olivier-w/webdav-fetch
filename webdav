#!/bin/bash
# WebDAV client â€” edit the lines below
URL="https://dav.example.com"
USER="user"
PASS="pass"
VPN="tun0"  # set to your VPN interface, or leave blank to use default route

case "$1" in
  ls)  _r=$(curl -sku "$USER:$PASS" ${VPN:+--interface "$VPN"} -X PROPFIND -H "Depth: 1" "$URL${2:-/}")
       printf '%s\n' "$_r" | grep -o 'href>[^<]*' | cut -d'>' -f2 | tr -d '\r' ;;
  get) _out="${2##*/}"
       if [ -f "$_out" ]; then echo "$_out ($(du -h "$_out" | cut -f1)): already exists"
       else curl -fkLu "$USER:$PASS" ${VPN:+--interface "$VPN"} "$URL$2" -o "$_out"
       fi ;;
  getall) if [ -f "$2" ]; then _paths=$(cat "$2")
          else _paths=$(webdav ls "${2:-/}" | grep -v '/$'); fi
          _n=0; _tot=$(printf '%s\n' "$_paths" | grep -c .)
          while IFS= read -r _p; do
            [ -z "$_p" ] && continue
            _n=$((_n+1)); echo "[$_n/$_tot]"
            "$0" get "$_p"
          done <<< "$_paths" ;;
  *)   echo "Usage: $(basename "$0") ls [path] | get <path> | getall [path]" ;;
esac
